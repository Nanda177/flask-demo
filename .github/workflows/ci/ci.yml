name: CI/CD for Flask on Kubernetes

on:
  push:
    branches: [ "dev", "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # ğŸ§± Step 1 â€” Checkout code
    - name: Checkout code
      uses: actions/checkout@v4

    # ğŸ³ Step 2 â€” Set up Docker
    - name: Set up Docker
      uses: docker/setup-buildx-action@v3

    # ğŸ”§ Step 3 â€” Build Docker image with unique tag
    - name: Build Docker image
      run: |
        docker build -t flask-demo:${{ github.run_number }} .
        echo "âœ… Built image flask-demo:${{ github.run_number }}"

    # ğŸ§° Step 4 â€” Set up kubectl
    - name: Set up kubectl
      uses: azure/setup-kubectl@v4
      with:
        version: 'latest'

    # â˜¸ï¸ Step 5 â€” Start Minikube (Local Kubernetes)
    - name: Start Minikube
      uses: medyagh/setup-minikube@master

    # ğŸ“¦ Step 6 â€” Load Docker image into Minikube
    - name: Load Docker image
      run: |
        minikube image load flask-demo:${{ github.run_number }}
        echo "âœ… Image loaded into Minikube"

    # ğŸ·ï¸ Step 7 â€” Set build version environment variable
    - name: Set build version env
      run: |
        export BUILD_VERSION=${{ github.run_number }}
        echo "âœ… BUILD_VERSION set to $BUILD_VERSION"

    # ğŸ—‚ï¸ Step 8 â€” Create Namespaces (if missing)
    - name: Ensure Namespaces Exist
      run: |
        kubectl get ns dev  || kubectl create namespace dev
        kubectl get ns prod || kubectl create namespace prod

    # ğŸš€ Step 9 â€” Apply Deployment and Update Image
    - name: Deploy to Kubernetes
      run: |
        if [[ "${{ github.ref_name }}" == "dev" ]]; then
          echo "ğŸš€ Deploying to DEV namespace"
          kubectl apply -f deployment.yaml -n dev
          kubectl set image deployment/flask-demo flask-demo=flask-demo:${{ github.run_number }} -n dev
          kubectl set env deployment/flask-demo BUILD_VERSION=${{ github.run_number }} -n dev
          kubectl rollout status deployment flask-demo -n dev
        elif [[ "${{ github.ref_name }}" == "main" ]]; then
          echo "ğŸš€ Deploying to PROD namespace"
          kubectl apply -f deployment.yaml -n prod
          kubectl set image deployment/flask-demo flask-demo=flask-demo:${{ github.run_number }} -n prod
          kubectl set env deployment/flask-demo BUILD_VERSION=${{ github.run_number }} -n prod
          kubectl rollout status deployment flask-demo -n prod
        fi

    # ğŸ” Step 10 â€” Verify Deployment
    - name: Verify Deployment
      run: |
        echo "âœ… Checking deployment status..."
        if [[ "${{ github.ref_name }}" == "dev" ]]; then
          kubectl get deployment flask-demo -n dev
          kubectl describe deployment flask-demo -n dev | grep Image:
          kubectl get pods -n dev
        elif [[ "${{ github.ref_name }}" == "main" ]]; then
          kubectl get deployment flask-demo -n prod
          kubectl describe deployment flask-demo -n prod | grep Image:
          kubectl get pods -n prod
        fi
