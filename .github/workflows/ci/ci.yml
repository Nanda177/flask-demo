name: CI/CD for Flask on Kubernetes

on:
  push:
    branches: [ "dev", "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # ğŸ§± Step 1 â€” Checkout code
    - name: Checkout code
      uses: actions/checkout@v4

    # ğŸ³ Step 2 â€” Set up Docker
    - name: Set up Docker
      uses: docker/setup-buildx-action@v3

    # ğŸ”§ Step 3 â€” Build Docker image with unique tag
    - name: Build Docker image
      run: |
        docker build -t flask-demo:${{ github.run_number }} .
        echo "âœ… Built image flask-demo:${{ github.run_number }}"

    # ğŸ§° Step 4 â€” Set up kubectl
    - name: Set up kubectl
      uses: azure/setup-kubectl@v4
      with:
        version: 'latest'

    # â˜¸ï¸ Step 5 â€” Set up Minikube
    - name: Start Minikube
      uses: medyagh/setup-minikube@master

    # ğŸ“¦ Step 6 â€” Load Docker image into Minikube
    - name: Load Docker image
      run: |
        minikube image load flask-demo:${{ github.run_number }}
        echo "âœ… Image loaded into Minikube"

    # ğŸ—‚ï¸ Step 7 â€” Create Namespace if it doesn't exist
    - name: Create Namespace
      run: |
        if [[ "${{ github.ref_name }}" == "dev" ]]; then
          kubectl get ns dev || kubectl create namespace dev
        elif [[ "${{ github.ref_name }}" == "main" ]]; then
          kubectl get ns prod || kubectl create namespace prod
        fi

    # ğŸš€ Step 8 â€” Deploy the New Image Version
    - name: Deploy to Kubernetes
      run: |
        if [[ "${{ github.ref_name }}" == "dev" ]]; then
          echo "ğŸš€ Deploying to DEV namespace"
          kubectl apply -f deployment.yaml -n dev
          kubectl set image deployment/flask-demo flask-demo=flask-demo:${{ github.run_number }} -n dev
          kubectl rollout status deployment flask-demo -n dev
        elif [[ "${{ github.ref_name }}" == "main" ]]; then
          echo "ğŸš€ Deploying to PROD namespace"
          kubectl apply -f deployment.yaml -n prod
          kubectl set image deployment/flask-demo flask-demo=flask-demo:${{ github.run_number }} -n prod
          kubectl rollout status deployment flask-demo -n prod
        fi

    # ğŸ” Step 9 â€” Verify Deployment
    - name: Verify Deployment
      run: |
        echo "âœ… Checking pod status..."
        if [[ "${{ github.ref_name }}" == "dev" ]]; then
          kubectl get all -n dev
        elif [[ "${{ github.ref_name }}" == "main" ]]; then
          kubectl get all -n prod
        fi
