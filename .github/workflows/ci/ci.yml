name: CI/CD for Flask on Kubernetes

on:
  push:
    branches: [ "dev", "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # ğŸ§± Step 1 â€” Checkout code
    - name: Checkout code
      uses: actions/checkout@v4

    # ğŸ³ Step 2 â€” Set up Docker
    - name: Set up Docker
      uses: docker/setup-buildx-action@v3

    # ğŸ”§ Step 3 â€” Build Docker image with unique tag (GitHub run number)
    - name: Build Docker image
      run: |
        docker build -t flask-demo:${{ github.run_number }} .
        echo "âœ… Built image flask-demo:${{ github.run_number }}"

    # ğŸ§° Step 4 â€” Set up kubectl
    - name: Set up kubectl
      uses: azure/setup-kubectl@v4
      with:
        version: 'latest'

    # â˜¸ï¸ Step 5 â€” Start Minikube (local cluster simulation)
    - name: Start Minikube
      uses: medyagh/setup-minikube@master

    # ğŸ“¦ Step 6 â€” Load Docker image into Minikube
    - name: Load Docker image
      run: |
        minikube image load flask-demo:${{ github.run_number }}
        echo "âœ… Image loaded into Minikube"

    # ğŸ—‚ï¸ Step 7 â€” Create Namespaces (if not exist)
    - name: Ensure Namespaces Exist
      run: |
        kubectl get ns dev  || kubectl create namespace dev
        kubectl get ns prod || kubectl create namespace prod

    # ğŸš€ Step 8 â€” Apply Deployment and Update Image Based on Branch
    - name: Deploy to Kubernetes
      run: |
        if [[ "${{ github.ref_name }}" == "dev" ]]; then
          echo "ğŸš€ Deploying to DEV namespace"
          kubectl apply -f deployment.yaml -n dev
          kubectl set image deployment/flask-demo flask-demo=flask-demo:${{ github.run_number }} -n dev
          kubectl rollout status deployment flask-demo -n dev
        elif [[ "${{ github.ref_name }}" == "main" ]]; then
          echo "ğŸš€ Deploying to PROD namespace"
          kubectl apply -f deployment.yaml -n prod
          kubectl set image deployment/flask-demo flask-demo=flask-demo:${{ github.run_number }} -n prod
          kubectl rollout status deployment flask-demo -n prod
        fi

    # ğŸ§¹ Step 9 â€” Cleanup old pods (optional)
    - name: Cleanup old pods
      run: |
        if [[ "${{ github.ref_name }}" == "dev" ]]; then
          kubectl delete pod -l app=flask-demo -n dev --ignore-not-found
        elif [[ "${{ github.ref_name }}" == "main" ]]; then
          kubectl delete pod -l app=flask-demo -n prod --ignore-not-found
        fi
        echo "ğŸ§¹ Cleaned up old pods"

    # ğŸ” Step 10 â€” Verify Deployment Status
    - name: Verify Deployment
      run: |
        echo "âœ… Checking deployment status..."
        if [[ "${{ github.ref_name }}" == "dev" ]]; then
          kubectl get deployment flask-demo -n dev
          kubectl get pods -n dev
          kubectl describe deployment flask-demo -n dev | grep Image:
        elif [[ "${{ github.ref_name }}" == "main" ]]; then
          kubectl get deployment flask-demo -n prod
          kubectl get pods -n prod
          kubectl describe deployment flask-demo -n prod | grep Image:
        fi
